<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reflections Data Architecture - Technical Implementation</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üßò</text></svg>">
    <link rel="stylesheet" href="mindvalley-styles.css">
    <style>
        .architecture-diagram {
            background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%);
            border: 3px solid #667eea;
            border-radius: 15px;
            padding: 40px;
            margin: 40px 0;
            position: relative;
        }

        .data-model {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
        }

        .data-model h4 {
            color: #667eea;
            font-size: 1.2em;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .field-list {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            background: #f7fafc;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .field-list .field {
            display: flex;
            gap: 15px;
            margin: 8px 0;
        }

        .field-name {
            color: #2d3748;
            font-weight: 600;
            min-width: 200px;
        }

        .field-type {
            color: #667eea;
            font-weight: 600;
        }

        .field-desc {
            color: #718096;
        }

        .flow-diagram {
            display: flex;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .flow-step {
            flex: 1;
            min-width: 200px;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .flow-step:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            border-color: #667eea;
        }

        .flow-step .step-number {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 15px;
            font-weight: 700;
            font-size: 1.2em;
        }

        .flow-step h4 {
            font-size: 1.1em;
            color: #2d3748;
            margin-bottom: 10px;
        }

        .flow-arrow {
            font-size: 2em;
            color: #667eea;
            font-weight: 700;
        }

        .code-example {
            background: #1a202c;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin: 25px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.8;
            overflow-x: auto;
        }

        .code-example .comment {
            color: #68d391;
        }

        .code-example .keyword {
            color: #f6ad55;
        }

        .code-example .string {
            color: #4fd1c5;
        }

        .code-example .function {
            color: #f687b3;
        }

        .mapping-table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }

        .mapping-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 18px;
            text-align: left;
            font-weight: 600;
            font-size: 1em;
        }

        .mapping-table td {
            padding: 18px;
            border-bottom: 1px solid #e2e8f0;
            vertical-align: top;
        }

        .mapping-table tr:hover {
            background: #f7fafc;
        }

        .mapping-table .reflection-input {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #f0fff4;
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            border-left: 3px solid #48bb78;
        }

        .mapping-table .outcome-tag {
            display: inline-block;
            background: #e6fffa;
            color: #234e52;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            margin: 4px;
            font-weight: 600;
        }

        .mapping-table .content-rec {
            display: block;
            background: #fef5e7;
            padding: 12px;
            border-radius: 6px;
            margin: 8px 0;
            border-left: 3px solid #d68910;
        }

        .alert-box {
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
            border: 2px solid #fc8181;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .alert-box h3 {
            color: #c53030;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .success-box {
            background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
            border: 2px solid #48bb78;
            border-radius: 12px;
            padding: 25px;
            margin: 30px 0;
        }

        .success-box h3 {
            color: #22543d;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .algorithm-box {
            background: linear-gradient(135deg, #fffaf0 0%, #feebc8 100%);
            border: 3px solid #ed8936;
            border-radius: 15px;
            padding: 30px;
            margin: 30px 0;
        }

        .algorithm-step {
            background: white;
            border-left: 4px solid #ed8936;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
        }

        .algorithm-step h4 {
            color: #c05621;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .sql-example {
            background: #2d3748;
            color: #e2e8f0;
            padding: 25px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.8;
            overflow-x: auto;
        }

        .sql-keyword {
            color: #f6ad55;
            font-weight: 600;
        }

        .sql-table {
            color: #4fd1c5;
        }

        .sql-field {
            color: #f687b3;
        }

        .implementation-phase {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 25px;
            margin: 20px 0;
            border-top: 5px solid #667eea;
        }

        .implementation-phase h4 {
            color: #667eea;
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .implementation-phase ul {
            list-style: none;
            padding-left: 0;
        }

        .implementation-phase li {
            padding: 12px 0 12px 35px;
            position: relative;
            border-bottom: 1px solid #e2e8f0;
        }

        .implementation-phase li:before {
            content: '‚úì';
            position: absolute;
            left: 0;
            top: 12px;
            background: #48bb78;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 700;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Hero Section -->
        <div class="hero-section" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 80px 40px; text-align: center;">
            <h1 style="font-size: 3em; margin-bottom: 20px; font-weight: 700;">Reflections Data Architecture</h1>
            <p style="font-size: 1.3em; opacity: 0.95; max-width: 900px; margin: 0 auto;">
                Technical implementation guide for connecting Reflections ‚Üí Outcomes ‚Üí Meditations/Quests
            </p>
            <p style="font-size: 1em; opacity: 0.85; margin-top: 20px;">
                Complete data model, recommendation algorithm, and database schema
            </p>
        </div>

        <!-- Main Content -->
        <div class="content-section" style="padding: 60px 40px;">

            <!-- System Overview -->
            <div class="section">
                <h2 class="section-title">üèóÔ∏è System Overview</h2>

                <div class="architecture-diagram">
                    <h3 style="text-align: center; color: #667eea; margin-bottom: 30px; font-size: 1.8em;">
                        Three-Layer Architecture
                    </h3>

                    <div class="flow-diagram">
                        <div class="flow-step">
                            <div class="step-number">1</div>
                            <h4>Reflections Layer</h4>
                            <p>User inputs daily reflections (Physical, Emotional, Cognitive)</p>
                        </div>

                        <div class="flow-arrow">‚Üí</div>

                        <div class="flow-step">
                            <div class="step-number">2</div>
                            <h4>Outcomes Bridge</h4>
                            <p>Maps reflection patterns to learning outcomes taxonomy</p>
                        </div>

                        <div class="flow-arrow">‚Üí</div>

                        <div class="flow-step">
                            <div class="step-number">3</div>
                            <h4>Content Layer</h4>
                            <p>Recommends meditations + Quests tagged with those outcomes</p>
                        </div>
                    </div>
                </div>

                <div class="success-box">
                    <h3>‚úì Why This Architecture Works</h3>
                    <ul style="padding-left: 25px; line-height: 2;">
                        <li><strong>Decoupled but connected</strong> - Reflections and content are separate but linked through outcomes</li>
                        <li><strong>Scalable</strong> - Add new reflections or content without breaking existing mappings</li>
                        <li><strong>Flexible</strong> - Outcomes taxonomy becomes your single source of truth</li>
                        <li><strong>Cross-product</strong> - Same outcomes bridge meditations AND Quests</li>
                    </ul>
                </div>
            </div>

            <!-- Data Model: Reflections -->
            <div class="section">
                <h2 class="section-title">üìä Data Model: Reflections Table</h2>

                <div class="data-model">
                    <h4>üóÉÔ∏è Table: user_reflections</h4>
                    <div class="field-list">
                        <div class="field">
                            <span class="field-name">id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Primary key</span>
                        </div>
                        <div class="field">
                            <span class="field-name">user_id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Foreign key to users table</span>
                        </div>
                        <div class="field">
                            <span class="field-name">timestamp</span>
                            <span class="field-type">TIMESTAMP</span>
                            <span class="field-desc">When reflection was recorded</span>
                        </div>
                        <div class="field">
                            <span class="field-name">sleep_quality</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['deep_restorative', 'good_enough', 'restless', 'terrible', 'didnt_sleep']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">energy_level</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['energized', 'balanced', 'low_energy', 'exhausted', 'wired_tired']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">dominant_emotion</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['peaceful', 'happy', 'neutral', 'anxious', 'stressed', 'sad', 'frustrated', 'overwhelmed']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">emotional_regulation</span>
                            <span class="field-type">INTEGER</span>
                            <span class="field-desc">1-10 scale</span>
                        </div>
                        <div class="field">
                            <span class="field-name">thought_quality</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['clear_focused', 'calm_present', 'scattered', 'racing', 'negative_loops', 'foggy']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">presence_level</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['fully_present', 'mostly_here', 'mind_wandering', 'lost_in_past', 'anxious_future']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">limiting_belief</span>
                            <span class="field-type">TEXT</span>
                            <span class="field-desc">Optional free text (NLP analyzed)</span>
                        </div>
                        <div class="field">
                            <span class="field-name">derived_outcomes</span>
                            <span class="field-type">JSON[]</span>
                            <span class="field-desc">Array of outcome IDs calculated at insert time</span>
                        </div>
                    </div>
                </div>

                <div class="alert-box">
                    <h3>‚ö° Key Design Decision: derived_outcomes Field</h3>
                    <p style="line-height: 1.8;">
                        Instead of storing raw reflections and calculating outcomes at query time (slow), we <strong>pre-calculate</strong>
                        the matching outcomes at insert time and store them in a JSON array. This makes recommendations blazing fast:
                        <br><br>
                        <code style="background: white; padding: 4px 8px; border-radius: 4px; color: #c53030;">
                            SELECT meditation_id FROM meditations WHERE outcomes && reflection.derived_outcomes
                        </code>
                    </p>
                </div>
            </div>

            <!-- Data Model: Outcomes -->
            <div class="section">
                <h2 class="section-title">üéØ Data Model: Outcomes Table</h2>

                <div class="data-model">
                    <h4>üóÉÔ∏è Table: outcomes</h4>
                    <div class="field-list">
                        <div class="field">
                            <span class="field-name">id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Primary key</span>
                        </div>
                        <div class="field">
                            <span class="field-name">name</span>
                            <span class="field-type">TEXT</span>
                            <span class="field-desc">e.g., "Reduce Anxiety", "Improve Sleep", "Increase Focus"</span>
                        </div>
                        <div class="field">
                            <span class="field-name">category</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['physical', 'emotional', 'cognitive', 'spiritual', 'social']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">description</span>
                            <span class="field-type">TEXT</span>
                            <span class="field-desc">Detailed explanation of what this outcome addresses</span>
                        </div>
                        <div class="field">
                            <span class="field-name">parent_outcome_id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">For hierarchical taxonomy (nullable)</span>
                        </div>
                    </div>
                </div>

                <div class="data-model">
                    <h4>üóÉÔ∏è Table: reflection_outcome_mappings</h4>
                    <p style="margin-bottom: 15px; color: #4a5568;">
                        <strong>Purpose:</strong> Defines which reflection patterns trigger which outcomes
                    </p>
                    <div class="field-list">
                        <div class="field">
                            <span class="field-name">id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Primary key</span>
                        </div>
                        <div class="field">
                            <span class="field-name">outcome_id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Foreign key to outcomes table</span>
                        </div>
                        <div class="field">
                            <span class="field-name">trigger_conditions</span>
                            <span class="field-type">JSON</span>
                            <span class="field-desc">Rule engine conditions that activate this outcome</span>
                        </div>
                        <div class="field">
                            <span class="field-name">weight</span>
                            <span class="field-type">FLOAT</span>
                            <span class="field-desc">0.0-1.0, how strongly this reflection indicates the outcome</span>
                        </div>
                        <div class="field">
                            <span class="field-name">time_sensitivity</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['immediate', 'recent_pattern', 'long_term']</span>
                        </div>
                    </div>
                </div>

                <p class="info-text" style="background: #f0fff4; padding: 20px; border-radius: 10px; border-left: 5px solid #48bb78; margin-top: 25px;">
                    <strong>üí° Why reflection_outcome_mappings?</strong><br><br>
                    This table is your rules engine. When a user submits a reflection, the system queries this table to determine
                    which outcomes apply. Example: If sleep_quality = 'restless' AND energy_level = 'exhausted',
                    trigger outcome "Improve Sleep Quality" with weight 0.9.
                </p>
            </div>

            <!-- Data Model: Content -->
            <div class="section">
                <h2 class="section-title">üßò Data Model: Content Tables</h2>

                <div class="data-model">
                    <h4>üóÉÔ∏è Table: meditations</h4>
                    <div class="field-list">
                        <div class="field">
                            <span class="field-name">id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Primary key</span>
                        </div>
                        <div class="field">
                            <span class="field-name">title</span>
                            <span class="field-type">TEXT</span>
                            <span class="field-desc">Meditation title</span>
                        </div>
                        <div class="field">
                            <span class="field-name">teacher_id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Foreign key to teachers table</span>
                        </div>
                        <div class="field">
                            <span class="field-name">duration_seconds</span>
                            <span class="field-type">INTEGER</span>
                            <span class="field-desc">Length in seconds</span>
                        </div>
                        <div class="field">
                            <span class="field-name">sound_technology</span>
                            <span class="field-type">ENUM[]</span>
                            <span class="field-desc">['binaural_beats', 'solfeggio', 'isochronic', 'nature', 'om', 'singing_bowls']</span>
                        </div>
                        <div class="field">
                            <span class="field-name">outcomes</span>
                            <span class="field-type">UUID[]</span>
                            <span class="field-desc">Array of outcome IDs this meditation addresses</span>
                        </div>
                        <div class="field">
                            <span class="field-name">efficacy_score</span>
                            <span class="field-type">FLOAT</span>
                            <span class="field-desc">0.0-1.0, how effective for its outcomes (calculated from user data)</span>
                        </div>
                    </div>
                </div>

                <div class="data-model">
                    <h4>üóÉÔ∏è Table: quests</h4>
                    <div class="field-list">
                        <div class="field">
                            <span class="field-name">id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Primary key</span>
                        </div>
                        <div class="field">
                            <span class="field-name">title</span>
                            <span class="field-type">TEXT</span>
                            <span class="field-desc">Quest title</span>
                        </div>
                        <div class="field">
                            <span class="field-name">author_id</span>
                            <span class="field-type">UUID</span>
                            <span class="field-desc">Foreign key to authors table</span>
                        </div>
                        <div class="field">
                            <span class="field-name">outcomes</span>
                            <span class="field-type">UUID[]</span>
                            <span class="field-desc">Array of outcome IDs this Quest addresses</span>
                        </div>
                        <div class="field">
                            <span class="field-name">duration_days</span>
                            <span class="field-type">INTEGER</span>
                            <span class="field-desc">Length of Quest program</span>
                        </div>
                        <div class="field">
                            <span class="field-name">intensity</span>
                            <span class="field-type">ENUM</span>
                            <span class="field-desc">['beginner', 'intermediate', 'advanced']</span>
                        </div>
                    </div>
                </div>

                <p class="info-text" style="background: #fffaf0; padding: 20px; border-radius: 10px; border-left: 5px solid #ed8936; margin-top: 25px;">
                    <strong>üîë Key Insight:</strong> Both <code>meditations</code> and <code>quests</code> tables have an
                    <code>outcomes</code> array field. This is what connects them to reflections. When a reflection triggers
                    outcomes [A, B, C], we query for content where <code>outcomes && [A, B, C]</code>.
                </p>
            </div>

            <!-- Recommendation Algorithm -->
            <div class="section">
                <h2 class="section-title">ü§ñ Recommendation Algorithm</h2>

                <div class="algorithm-box">
                    <h3 style="text-align: center; color: #c05621; margin-bottom: 30px; font-size: 1.6em;">
                        Multi-Factor Scoring System
                    </h3>

                    <div class="algorithm-step">
                        <h4>Step 1: Extract Outcomes from Latest Reflection</h4>
                        <p>Query the most recent user reflection and extract the <code>derived_outcomes</code> array.</p>
                        <div class="code-example">
<span class="keyword">const</span> latestReflection = <span class="keyword">await</span> db.<span class="function">query</span>(<span class="string">`
    SELECT derived_outcomes, timestamp
    FROM user_reflections
    WHERE user_id = $1
    ORDER BY timestamp DESC
    LIMIT 1
`</span>, [userId]);

<span class="keyword">const</span> immediateOutcomes = latestReflection.derived_outcomes;
<span class="comment">// Example: ['reduce_anxiety', 'improve_sleep', 'calm_nervous_system']</span>
                        </div>
                    </div>

                    <div class="algorithm-step">
                        <h4>Step 2: Identify Pattern-Based Outcomes</h4>
                        <p>Look at the last 7 days of reflections to find persistent patterns.</p>
                        <div class="code-example">
<span class="keyword">const</span> recentPatterns = <span class="keyword">await</span> db.<span class="function">query</span>(<span class="string">`
    SELECT
        UNNEST(derived_outcomes) as outcome_id,
        COUNT(*) as frequency
    FROM user_reflections
    WHERE user_id = $1
    AND timestamp > NOW() - INTERVAL '7 days'
    GROUP BY outcome_id
    HAVING COUNT(*) >= 5
`</span>, [userId]);

<span class="comment">// If user has been anxious 5+ days in a row, recommend deeper work (Quest)</span>
                        </div>
                    </div>

                    <div class="algorithm-step">
                        <h4>Step 3: Calculate Content Scores</h4>
                        <p>Score each meditation/Quest based on multiple factors:</p>
                        <div class="code-example">
<span class="keyword">function</span> <span class="function">calculateScore</span>(content, user) {
    <span class="keyword">let</span> score = 0;

    <span class="comment">// Factor 1: Outcome match (40% weight)</span>
    <span class="keyword">const</span> outcomeMatch = content.outcomes.<span class="function">filter</span>(o =>
        immediateOutcomes.<span class="function">includes</span>(o)
    ).length / immediateOutcomes.length;
    score += outcomeMatch * 0.4;

    <span class="comment">// Factor 2: Historical efficacy (30% weight)</span>
    score += content.efficacy_score * 0.3;

    <span class="comment">// Factor 3: Recency bias (15% weight)</span>
    <span class="comment">// Prefer content released in last 6 months</span>
    <span class="keyword">const</span> daysSinceRelease = (Date.<span class="function">now</span>() - content.release_date) / (1000*60*60*24);
    <span class="keyword">const</span> recencyScore = Math.<span class="function">max</span>(0, 1 - (daysSinceRelease / 180));
    score += recencyScore * 0.15;

    <span class="comment">// Factor 4: Novelty (15% weight)</span>
    <span class="comment">// Boost content user hasn't tried yet</span>
    <span class="keyword">const</span> hasCompleted = user.completedContent.<span class="function">includes</span>(content.id);
    score += hasCompleted ? 0 : 0.15;

    <span class="keyword">return</span> score;
}
                        </div>
                    </div>

                    <div class="algorithm-step">
                        <h4>Step 4: Apply Business Rules</h4>
                        <p>Final filtering based on context and constraints:</p>
                        <ul style="padding-left: 25px; line-height: 2; margin-top: 15px;">
                            <li><strong>Time constraint:</strong> If reflection at night ‚Üí prioritize sleep meditations</li>
                            <li><strong>Duration preference:</strong> User history shows 10-15 min preferred ‚Üí filter out 30+ min</li>
                            <li><strong>Pattern escalation:</strong> If anxiety 7+ days ‚Üí recommend Quest, not just meditation</li>
                            <li><strong>Diversity:</strong> Ensure recommendations span multiple sound technologies</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Mapping Examples -->
            <div class="section">
                <h2 class="section-title">üó∫Ô∏è Reflection ‚Üí Outcome ‚Üí Content Mappings</h2>

                <p style="font-size: 1.1em; color: #4a5568; margin-bottom: 30px;">
                    Concrete examples showing how reflection patterns map to outcomes and trigger specific content recommendations:
                </p>

                <table class="mapping-table">
                    <thead>
                        <tr>
                            <th style="width: 25%;">Reflection Input</th>
                            <th style="width: 25%;">Triggered Outcomes</th>
                            <th style="width: 25%;">Meditation Rec</th>
                            <th style="width: 25%;">Quest Rec (if pattern)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>
                                <div class="reflection-input">
                                    Sleep: "Restless"<br>
                                    Energy: "Exhausted"<br>
                                    Emotion: "Stressed"
                                </div>
                            </td>
                            <td>
                                <span class="outcome-tag">Improve Sleep</span>
                                <span class="outcome-tag">Calm Nervous System</span>
                                <span class="outcome-tag">Reduce Stress</span>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Yoga Nidra for Deep Sleep</strong><br>
                                    <small>30 min ‚Ä¢ Delta waves ‚Ä¢ Emily Fletcher</small>
                                </div>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>The Ultimate Sleep Quest</strong><br>
                                    <small>If pattern 5+ days</small>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="reflection-input">
                                    Emotion: "Anxious"<br>
                                    Regulation: 3/10<br>
                                    Thoughts: "Racing"<br>
                                    Presence: "Anxious about future"
                                </div>
                            </td>
                            <td>
                                <span class="outcome-tag">Reduce Anxiety</span>
                                <span class="outcome-tag">Calm Mind</span>
                                <span class="outcome-tag">Increase Presence</span>
                                <span class="outcome-tag">Emotional Regulation</span>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Box Breathing for Anxiety</strong><br>
                                    <small>10 min ‚Ä¢ Binaural beats ‚Ä¢ Paul McKenna</small>
                                </div>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Quest for Personal Mastery</strong><br>
                                    <small>Srikumar Rao ‚Ä¢ If 7+ days</small>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="reflection-input">
                                    Thoughts: "Negative loops"<br>
                                    Limiting belief: "I'm not good enough"<br>
                                    Regulation: 4/10
                                </div>
                            </td>
                            <td>
                                <span class="outcome-tag">Cognitive Reframe</span>
                                <span class="outcome-tag">Self-Compassion</span>
                                <span class="outcome-tag">Break Negative Patterns</span>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Loving-Kindness Meditation</strong><br>
                                    <small>15 min ‚Ä¢ 528 Hz ‚Ä¢ Jack Kornfield</small>
                                </div>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>6 Phase Meditation Quest</strong><br>
                                    <small>Vishen ‚Ä¢ Gratitude + self-love focus</small>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="reflection-input">
                                    Energy: "Wired but tired"<br>
                                    Thoughts: "Scattered"<br>
                                    Presence: "Mind wandering"
                                </div>
                            </td>
                            <td>
                                <span class="outcome-tag">Parasympathetic Activation</span>
                                <span class="outcome-tag">Improve Focus</span>
                                <span class="outcome-tag">Ground & Center</span>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Body Scan Meditation</strong><br>
                                    <small>20 min ‚Ä¢ Nature sounds ‚Ä¢ Jon Kabat-Zinn</small>
                                </div>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Superbrain Quest</strong><br>
                                    <small>Jim Kwik ‚Ä¢ Focus + mental clarity</small>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>
                                <div class="reflection-input">
                                    Sleep: "Good enough"<br>
                                    Energy: "Balanced"<br>
                                    Emotion: "Neutral"<br>
                                    Thoughts: "Calm & present"
                                </div>
                            </td>
                            <td>
                                <span class="outcome-tag">Maintain Balance</span>
                                <span class="outcome-tag">Deepen Practice</span>
                                <span class="outcome-tag">Spiritual Growth</span>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Advanced Mindfulness</strong><br>
                                    <small>25 min ‚Ä¢ Silent ‚Ä¢ S.N. Goenka</small>
                                </div>
                            </td>
                            <td>
                                <div class="content-rec">
                                    <strong>Duality Quest</strong><br>
                                    <small>Jeffrey Allen ‚Ä¢ When ready to level up</small>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>

                <div class="success-box">
                    <h3>üéØ Pattern Recognition Rules</h3>
                    <ul style="padding-left: 25px; line-height: 2; margin-top: 15px;">
                        <li><strong>1-3 days:</strong> Recommend meditations only (immediate relief)</li>
                        <li><strong>5-7 days:</strong> Show Quest recommendation as "Consider deeper work"</li>
                        <li><strong>7+ days:</strong> Prioritize Quest in recommendations, position as transformational solution</li>
                        <li><strong>14+ days:</strong> Trigger "persistent pattern" notification, recommend professional support resources</li>
                    </ul>
                </div>
            </div>

            <!-- SQL Queries -->
            <div class="section">
                <h2 class="section-title">üíæ SQL Query Examples</h2>

                <h3 style="color: #2d3748; margin-bottom: 20px;">Query 1: Get Meditation Recommendations</h3>
                <div class="sql-example">
<span class="sql-keyword">WITH</span> user_outcomes <span class="sql-keyword">AS</span> (
    <span class="sql-keyword">SELECT</span> <span class="sql-field">derived_outcomes</span>
    <span class="sql-keyword">FROM</span> <span class="sql-table">user_reflections</span>
    <span class="sql-keyword">WHERE</span> <span class="sql-field">user_id</span> = <span class="string">'user-uuid'</span>
    <span class="sql-keyword">ORDER BY</span> <span class="sql-field">timestamp</span> <span class="sql-keyword">DESC</span>
    <span class="sql-keyword">LIMIT</span> 1
)
<span class="sql-keyword">SELECT</span>
    m.<span class="sql-field">id</span>,
    m.<span class="sql-field">title</span>,
    m.<span class="sql-field">teacher_id</span>,
    m.<span class="sql-field">duration_seconds</span>,
    m.<span class="sql-field">efficacy_score</span>,
    <span class="comment">-- Calculate match score</span>
    <span class="function">CARDINALITY</span>(m.<span class="sql-field">outcomes</span> && uo.<span class="sql-field">derived_outcomes</span>) /
    <span class="function">CARDINALITY</span>(uo.<span class="sql-field">derived_outcomes</span>) <span class="sql-keyword">AS</span> match_score
<span class="sql-keyword">FROM</span> <span class="sql-table">meditations</span> m
<span class="sql-keyword">CROSS JOIN</span> user_outcomes uo
<span class="sql-keyword">WHERE</span> m.<span class="sql-field">outcomes</span> && uo.<span class="sql-field">derived_outcomes</span> <span class="comment">-- Array overlap operator</span>
<span class="sql-keyword">ORDER BY</span> match_score <span class="sql-keyword">DESC</span>, m.<span class="sql-field">efficacy_score</span> <span class="sql-keyword">DESC</span>
<span class="sql-keyword">LIMIT</span> 10;
                </div>

                <h3 style="color: #2d3748; margin: 40px 0 20px 0;">Query 2: Detect Persistent Patterns (Quest Trigger)</h3>
                <div class="sql-example">
<span class="sql-keyword">SELECT</span>
    <span class="function">UNNEST</span>(<span class="sql-field">derived_outcomes</span>) <span class="sql-keyword">AS</span> outcome_id,
    <span class="function">COUNT</span>(*) <span class="sql-keyword">AS</span> frequency,
    <span class="function">MAX</span>(<span class="sql-field">timestamp</span>) <span class="sql-keyword">AS</span> last_occurrence
<span class="sql-keyword">FROM</span> <span class="sql-table">user_reflections</span>
<span class="sql-keyword">WHERE</span> <span class="sql-field">user_id</span> = <span class="string">'user-uuid'</span>
<span class="sql-keyword">AND</span> <span class="sql-field">timestamp</span> > <span class="function">NOW</span>() - <span class="sql-keyword">INTERVAL</span> <span class="string">'7 days'</span>
<span class="sql-keyword">GROUP BY</span> outcome_id
<span class="sql-keyword">HAVING</span> <span class="function">COUNT</span>(*) >= 5 <span class="comment">-- 5+ occurrences in 7 days = persistent</span>
<span class="sql-keyword">ORDER BY</span> frequency <span class="sql-keyword">DESC</span>;

<span class="comment">-- Then fetch matching Quests:</span>
<span class="sql-keyword">SELECT</span> q.*
<span class="sql-keyword">FROM</span> <span class="sql-table">quests</span> q
<span class="sql-keyword">WHERE</span> q.<span class="sql-field">outcomes</span> && <span class="function">ARRAY</span>[<span class="string">'persistent-outcome-ids'</span>]
<span class="sql-keyword">ORDER BY</span> q.<span class="sql-field">efficacy_score</span> <span class="sql-keyword">DESC</span>;
                </div>

                <h3 style="color: #2d3748; margin: 40px 0 20px 0;">Query 3: Insert Reflection with Auto-Outcome Derivation</h3>
                <div class="sql-example">
<span class="comment">-- Step 1: Insert raw reflection data</span>
<span class="sql-keyword">INSERT INTO</span> <span class="sql-table">user_reflections</span> (
    <span class="sql-field">user_id</span>,
    <span class="sql-field">sleep_quality</span>,
    <span class="sql-field">energy_level</span>,
    <span class="sql-field">dominant_emotion</span>,
    <span class="sql-field">thought_quality</span>,
    <span class="sql-field">presence_level</span>
) <span class="sql-keyword">VALUES</span> (
    <span class="string">'user-uuid'</span>,
    <span class="string">'restless'</span>,
    <span class="string">'exhausted'</span>,
    <span class="string">'stressed'</span>,
    <span class="string">'racing'</span>,
    <span class="string">'anxious_future'</span>
)
<span class="sql-keyword">RETURNING</span> <span class="sql-field">id</span>;

<span class="comment">-- Step 2: Calculate matching outcomes using rules engine</span>
<span class="sql-keyword">SELECT</span> <span class="sql-field">outcome_id</span>, <span class="sql-field">weight</span>
<span class="sql-keyword">FROM</span> <span class="sql-table">reflection_outcome_mappings</span>
<span class="sql-keyword">WHERE</span>
    (<span class="sql-field">trigger_conditions</span>->><span class="string">'sleep_quality'</span> = <span class="string">'restless'</span> <span class="sql-keyword">OR</span>
     <span class="sql-field">trigger_conditions</span>->><span class="string">'sleep_quality'</span> <span class="sql-keyword">IS NULL</span>)
<span class="sql-keyword">AND</span>
    (<span class="sql-field">trigger_conditions</span>->><span class="string">'energy_level'</span> = <span class="string">'exhausted'</span> <span class="sql-keyword">OR</span>
     <span class="sql-field">trigger_conditions</span>->><span class="string">'energy_level'</span> <span class="sql-keyword">IS NULL</span>)
<span class="comment">-- ... match all conditions</span>
<span class="sql-keyword">ORDER BY</span> <span class="sql-field">weight</span> <span class="sql-keyword">DESC</span>;

<span class="comment">-- Step 3: Update reflection with derived outcomes</span>
<span class="sql-keyword">UPDATE</span> <span class="sql-table">user_reflections</span>
<span class="sql-keyword">SET</span> <span class="sql-field">derived_outcomes</span> = <span class="function">ARRAY</span>[<span class="string">'outcome-uuids'</span>]
<span class="sql-keyword">WHERE</span> <span class="sql-field">id</span> = <span class="string">'reflection-uuid'</span>;
                </div>
            </div>

            <!-- Implementation Phases -->
            <div class="section">
                <h2 class="section-title">üöÄ Implementation Roadmap</h2>

                <div class="implementation-phase">
                    <h4>Phase 1: Foundation (Weeks 1-2)</h4>
                    <ul>
                        <li>Create database schema (all tables above)</li>
                        <li>Seed outcomes taxonomy (start with 50-100 core outcomes)</li>
                        <li>Build reflection_outcome_mappings rules (manual curation of ~200 rules)</li>
                        <li>Tag existing meditations with outcomes (batch operation)</li>
                        <li>Build basic reflection capture UI</li>
                    </ul>
                </div>

                <div class="implementation-phase">
                    <h4>Phase 2: Basic Recommendations (Weeks 3-4)</h4>
                    <ul>
                        <li>Implement outcome derivation logic (on reflection insert)</li>
                        <li>Build meditation recommendation query (immediate outcomes only)</li>
                        <li>Create simple recommendation UI ("Based on your reflection, try...")</li>
                        <li>A/B test: Reflections-based recs vs. random recs</li>
                        <li>Measure: Click-through rate, completion rate</li>
                    </ul>
                </div>

                <div class="implementation-phase">
                    <h4>Phase 3: Pattern Detection (Weeks 5-6)</h4>
                    <ul>
                        <li>Implement 7-day pattern analysis query</li>
                        <li>Add Quest recommendations for persistent patterns</li>
                        <li>Build "Your Patterns" dashboard showing trends</li>
                        <li>Implement pattern-based notifications ("You've been stressed for 5 days...")</li>
                        <li>Measure: Quest conversion rate from pattern-triggered recs</li>
                    </ul>
                </div>

                <div class="implementation-phase">
                    <h4>Phase 4: AI Enhancement (Weeks 7-10)</h4>
                    <ul>
                        <li>Train ML model on reflection ‚Üí outcome associations (improve rules engine)</li>
                        <li>NLP analysis of limiting_belief text field ‚Üí extract additional outcomes</li>
                        <li>Personalized efficacy scoring (meditation X works better for user Y)</li>
                        <li>Implement multi-armed bandit for exploration vs exploitation</li>
                        <li>Build feedback loop: "Was this recommendation helpful?"</li>
                    </ul>
                </div>

                <div class="implementation-phase">
                    <h4>Phase 5: Cross-Product Intelligence (Weeks 11-12)</h4>
                    <ul>
                        <li>Tag ALL Quests with outcomes (not just new ones)</li>
                        <li>Implement unified recommendation API (meditations + Quests)</li>
                        <li>Build "Your Learning Path" showing meditation ‚Üí Quest progression</li>
                        <li>Add social proof: "Users with similar patterns completed this Quest"</li>
                        <li>Measure: 66-day retention, Quest conversion, LTV increase</li>
                    </ul>
                </div>
            </div>

            <!-- Expected Outcomes -->
            <div class="section">
                <h2 class="section-title">üìà Expected Impact</h2>

                <table class="data-table" style="margin-top: 30px;">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <th>Baseline (No Reflections)</th>
                            <th>Target (With Reflections)</th>
                            <th>Lift</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Day 15 Retention</strong></td>
                            <td>4%</td>
                            <td>10-15%</td>
                            <td style="color: #48bb78; font-weight: 600;">+150-275%</td>
                        </tr>
                        <tr>
                            <td><strong>Day 66 Retention</strong></td>
                            <td>2%</td>
                            <td>8-12%</td>
                            <td style="color: #48bb78; font-weight: 600;">+300-500%</td>
                        </tr>
                        <tr>
                            <td><strong>Meditation Completion Rate</strong></td>
                            <td>45%</td>
                            <td>65-75%</td>
                            <td style="color: #48bb78; font-weight: 600;">+44-67%</td>
                        </tr>
                        <tr>
                            <td><strong>Quest Conversion (from meditation users)</strong></td>
                            <td>2%</td>
                            <td>8-12%</td>
                            <td style="color: #48bb78; font-weight: 600;">+300-500%</td>
                        </tr>
                        <tr>
                            <td><strong>User LTV</strong></td>
                            <td>$120</td>
                            <td>$280-350</td>
                            <td style="color: #48bb78; font-weight: 600;">+133-192%</td>
                        </tr>
                    </tbody>
                </table>

                <div class="alert-box" style="background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%); border-color: #48bb78;">
                    <h3 style="color: #22543d;">üí∞ Revenue Impact Calculation</h3>
                    <p style="line-height: 1.8; color: #2d3748;">
                        Assuming 10,000 meditation app users:<br><br>

                        <strong>Without Reflections:</strong><br>
                        ‚Ä¢ 10,000 users √ó 2% Quest conversion √ó $199 Quest = <strong>$39,800/month</strong><br><br>

                        <strong>With Reflections:</strong><br>
                        ‚Ä¢ 10,000 users √ó 10% Quest conversion √ó $199 Quest = <strong>$199,000/month</strong><br><br>

                        <span style="font-size: 1.3em; color: #22543d; font-weight: 700;">
                            Net Increase: +$159,200/month = $1,910,400/year
                        </span>
                    </p>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="section">
                <h2 class="section-title">‚úÖ Immediate Next Steps</h2>

                <div style="background: linear-gradient(135deg, #f0f4ff 0%, #e8eeff 100%); border-radius: 15px; padding: 40px; margin-top: 30px;">
                    <ol style="font-size: 1.1em; line-height: 2.5; padding-left: 30px;">
                        <li><strong>Design Outcomes Taxonomy Workshop</strong> - Gather product/content teams to define 50-100 core outcomes</li>
                        <li><strong>Audit Meditation Database</strong> - Assess current meditation metadata, identify tagging gaps</li>
                        <li><strong>Create Reflection UI Prototype</strong> - Build interactive mockup of daily reflection flow</li>
                        <li><strong>Define Reflection ‚Üí Outcome Rules</strong> - Start with 10 most common reflection patterns</li>
                        <li><strong>Set Up Analytics Events</strong> - Track reflection_submitted, recommendation_clicked, content_completed</li>
                        <li><strong>Build MVP Backend</strong> - Implement core tables and basic recommendation query</li>
                        <li><strong>Run Pilot Test</strong> - 100 users for 2 weeks, measure engagement vs. control group</li>
                        <li><strong>Iterate Based on Data</strong> - Refine outcome rules, improve recommendation accuracy</li>
                    </ol>
                </div>
            </div>

        </div>

        <!-- Footer -->
        <div class="footer" style="background: #f7fafc; padding: 40px; text-align: center; border-top: 1px solid #e2e8f0;">
            <p style="font-size: 1.1em; color: #2d3748; margin-bottom: 15px;">
                <strong>Reflections Data Architecture</strong> | Technical Implementation Guide
            </p>
            <p style="color: #718096; margin-bottom: 20px;">
                Complete data model for connecting daily reflections to personalized meditation and Quest recommendations
            </p>
            <div style="display: flex; gap: 20px; justify-content: center; flex-wrap: wrap; margin-top: 25px;">
                <a href="reflections-framework.html" style="color: #667eea; text-decoration: none; font-weight: 600;">‚Üê Back to Reflections Framework</a>
                <span style="color: #cbd5e0;">|</span>
                <a href="recommendation-strategy-proposal.html" style="color: #667eea; text-decoration: none; font-weight: 600;">View Recommendation Strategy</a>
                <span style="color: #cbd5e0;">|</span>
                <a href="../index.html" style="color: #667eea; text-decoration: none; font-weight: 600;">Team Hub ‚Üí</a>
            </div>
            <p style="margin-top: 30px; font-size: 0.9em; color: #a0aec0;">
                ü§ñ Built with Claude Code | Mindvalley Product Team | November 2025
            </p>
        </div>
    </div>
</body>
</html>